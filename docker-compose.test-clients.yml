# Test stack for download client development
# Includes cwabd + all download clients on same network with shared volumes
#
# Usage:
#   docker compose -f docker-compose.test-clients.yml up -d
#   # Access cwabd at http://localhost:8084
#   # Configure clients in Settings > Prowlarr > Download Clients
#
# Web UIs:
#   - cwabd:        http://localhost:8084
#   - Prowlarr:     http://localhost:9696 (no auth by default)
#   - qBittorrent:  http://localhost:8080 (admin / adminadmin - check logs for temp password)
#   - Transmission: http://localhost:9091 (admin / admin)
#   - Deluge:       http://localhost:8112 (password: deluge)
#   - NZBGet:       http://localhost:6789 (nzbget / tegbzn6789)
#   - SABnzbd:      http://localhost:8085 (complete setup wizard for API key)
#   - aMule:        http://localhost:4711 (password: amule)
#   - Amarr:        http://localhost:8086 (torznab indexer + qBittorrent emulation for amule)
#
# Hot-reload: Python code changes are picked up automatically (source mounted)
# Rebuild needed only for: requirements changes, frontend changes, Dockerfile changes

services:
  # ============ MAIN APPLICATION ============

  cwabd:
    build:
      context: .
      dockerfile: Dockerfile
      target: cwa-bd
    container_name: test-cwabd
    environment:
      TZ: UTC
      DEBUG: "true"
      # All client configuration is done via Settings UI
      # Use Docker service names for URLs:
      #   - Transmission: http://transmission:9091
      #   - Deluge host: deluge (port 58846)
      #   - SABnzbd: http://sabnzbd:8080
    ports:
      - "8084:8084"
    volumes:
      # Config and state
      - ./.local/test-clients/cwabd/config:/config
      - ./.local/test-clients/cwabd/log:/var/log/cwa-book-downloader
      # Book destination directory (where completed books go)
      - ./.local/test-clients/books:/books
      # Staging directory
      - ./.local/test-clients/tmp:/tmp/cwa-book-downloader
      # CRITICAL: Mount client download directories so cwabd can access completed files
      - ./.local/test-clients/downloads:/downloads
      # Mount source code for hot-reload (no rebuild needed for Python changes)
      - ./cwa_book_downloader:/app/cwa_book_downloader:ro
      # Mount tests for running pytest in container
      - ./tests:/app/tests:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
      # Mount client configs for integration tests to read credentials
      - ./.local/test-clients/qbittorrent/config:/qbittorrent-config:ro
      - ./.local/test-clients/sabnzbd/config:/sabnzbd-config:ro
    depends_on:
      - nzbget
      - sabnzbd
      - qbittorrent
      - transmission
      - deluge
    restart: unless-stopped

  # ============ PROWLARR (INDEXER MANAGER) ============

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: test-prowlarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - ./.local/test-clients/prowlarr/config:/config
    ports:
      - "9696:9696"
    restart: unless-stopped

  # ============ USENET CLIENTS ============

  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: test-nzbget
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - ./.local/test-clients/nzbget/config:/config
      - ./.local/test-clients/downloads:/downloads
      - ./.local/test-clients/nzbget/custom-cont-init.d:/custom-cont-init.d:ro
    ports:
      - "6789:6789"  # Web UI / JSON-RPC
    restart: unless-stopped

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: test-sabnzbd
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
    volumes:
      - ./.local/test-clients/sabnzbd/config:/config
      - ./.local/test-clients/downloads:/downloads
    ports:
      - "8085:8080"  # Web UI (external:internal)
    restart: unless-stopped

  # ============ TORRENT CLIENTS ============

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: test-qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - WEBUI_PORT=8080
    volumes:
      - ./.local/test-clients/qbittorrent/config:/config
      - ./.local/test-clients/downloads:/downloads
      - ./.local/test-clients/qbittorrent/custom-cont-init.d:/custom-cont-init.d:ro
    ports:
      - "8080:8080"  # Web UI / API
      - "6882:6881"
      - "6882:6881/udp"
    restart: unless-stopped

  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: test-transmission
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - USER=admin
      - PASS=admin
    volumes:
      - ./.local/test-clients/transmission/config:/config
      - ./.local/test-clients/downloads:/downloads
    ports:
      - "9091:9091"  # Web UI / RPC
      - "51413:51413"
      - "51413:51413/udp"
    restart: unless-stopped

  deluge:
    image: lscr.io/linuxserver/deluge:latest
    container_name: test-deluge
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - DELUGE_LOGLEVEL=error
    volumes:
      - ./.local/test-clients/deluge/config:/config
      - ./.local/test-clients/downloads:/downloads
    ports:
      - "8112:8112"  # Web UI
      - "58846:58846"  # Daemon RPC
      - "6881:6881"
      - "6881:6881/udp"
    restart: unless-stopped

  # ============ AMULE + AMARR BRIDGE ============

  amule:
    image: ngosang/amule:latest
    container_name: test-amule
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - GUI_PWD=amule
      - WEBUI_PWD=amule
    volumes:
      - ./.local/test-clients/amule/config:/home/amule/.aMule
      - ./.local/test-clients/downloads:/incoming
      - ./.local/test-clients/amule/temp:/temp
    ports:
      - "4711:4711"   # Web UI
      - "4712:4712"   # EC (External Connections) for Amarr
      - "4662:4662"   # ED2K TCP
      - "4665:4665/udp"  # ED2K global search
      - "4672:4672/udp"  # ED2K UDP
    restart: unless-stopped

  amarr:
    image: vexdev/amarr:latest
    container_name: test-amarr
    environment:
      - AMULE_HOST=amule
      - AMULE_PORT=4712
      - AMULE_PASSWORD=amule
      - AMULE_FINISHED_PATH=/downloads
      - AMARR_LOG_LEVEL=DEBUG
    volumes:
      - ./.local/test-clients/amarr/config:/config
      - ./.local/test-clients/downloads:/downloads
    ports:
      - "8086:8080"  # Amarr web/API (torznab indexer + qBittorrent emulation)
    depends_on:
      - amule
    restart: unless-stopped

# All services automatically on same network (test-clients_default)
